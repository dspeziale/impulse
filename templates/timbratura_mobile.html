<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Impulse | Scan QR</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- Awesome Notifications -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesome-notifications/3.1.3/style.min.css">
</head>

<body class="hold-transition login-page">
    <div class="login-box" style="width: 90%; max-width: 400px;">
        <div class="login-logo">
            <a href="#"><b>Impulse</b>Scan</a>
        </div>
        <!-- /.login-logo -->
        <div class="card">
            <div class="card-body login-card-body">
                <p class="login-box-msg">Scan Cantiere QR Code</p>

                <div class="row mb-3">
                    <div class="col-6">
                        <button id="btn-camera" class="btn btn-outline-primary btn-block">
                            <i class="fas fa-camera"></i> Camera
                        </button>
                    </div>
                    <div class="col-6">
                        <label class="btn btn-outline-secondary btn-block mb-0">
                            <i class="fas fa-upload"></i> Upload
                            <input type="file" id="qr-file" accept="image/*" hidden>
                        </label>
                    </div>
                </div>

                <div id="reader-container" class="d-none mb-3">
                    <div id="reader" width="100%"></div>
                    <button id="stop-camera" class="btn btn-sm btn-danger btn-block mt-2">Stop Camera</button>
                </div>

                <div id="result-area" class="d-none text-center mt-3">
                    <h4 id="cantiere-name" class="text-primary"></h4>
                    <p id="scan-status" class="text-muted"></p>
                    <input type="hidden" id="qr-data">
                    <input type="hidden" id="gps-lat">
                    <input type="hidden" id="gps-lon">

                    <button id="confirm-btn" class="btn btn-success btn-block btn-lg mt-3">
                        <i class="fas fa-check-circle"></i> Confirm Stamp
                    </button>
                    <button id="retry-btn" class="btn btn-secondary btn-block mt-2">
                        Scan Again
                    </button>
                </div>

                <div id="gps-status" class="alert alert-info mt-3">
                    <i class="fas fa-spinner fa-spin"></i> Acquiring GPS...
                </div>

                <a href="/" class="btn btn-link btn-block mt-2">Back to Dashboard</a>

            </div>
            <!-- /.login-card-body -->
        </div>
    </div>
    <!-- /.login-box -->

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- AdminLTE App -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- HTML5-QRCode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Awesome Notifications -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesome-notifications/3.1.3/index.var.min.js"></script>

    <script>
        let notifier = new AWN();
        let html5QrCode;
        let lastDecodedText = null;
        let isProcessing = false;

        // GPS Logic
        function getGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError, { enableHighAccuracy: true });
            } else {
                $('#gps-status').removeClass('alert-info').addClass('alert-danger').html("Geolocation is not supported by this browser.");
            }
        }

        function showPosition(position) {
            $('#gps-lat').val(position.coords.latitude);
            $('#gps-lon').val(position.coords.longitude);
            $('#gps-status').removeClass('alert-info').addClass('alert-success').html('<i class="fas fa-map-marker-alt"></i> GPS Acquired');
        }

        function showError(error) {
            let msg = "";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    msg = "User denied the request for Geolocation."
                    break;
                case error.POSITION_UNAVAILABLE:
                    msg = "Location information is unavailable."
                    break;
                case error.TIMEOUT:
                    msg = "The request to get user location timed out."
                    break;
                case error.UNKNOWN_ERROR:
                    msg = "An unknown error occurred."
                    break;
            }
            $('#gps-status').removeClass('alert-info').addClass('alert-danger').html(msg);
        }

        function submitScan(qrCode, force = false, notes = "") {
            if (isProcessing) return;
            isProcessing = true;

            const lat = $('#gps-lat').val();
            const lon = $('#gps-lon').val();

            // Show processing state
            $('#scan-status').html('<i class="fas fa-spinner fa-spin"></i> Processing...');
            $('#result-area').removeClass('d-none');
            $('#reader-container').addClass('d-none');

            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(console.error);
            }

            if (!lat || !lon) {
                notifier.alert("GPS Position required! Wait for GPS...");
                isProcessing = false;
                // Restart scan?
                return;
            }

            $.ajax({
                url: '/api/timbratura',
                type: 'POST',
                data: {
                    qr_code: qrCode,
                    lat: lat,
                    lon: lon,
                    force_gps: force,
                    notes: notes
                },
                success: function (response) {
                    if (response.success) {
                        notifier.success(response.message);
                        $('#scan-status').html('<i class="fas fa-check-circle text-success"></i> ' + response.message);
                        setTimeout(() => location.href = "/", 2000);
                    } else {
                        // Logic error (shouldn't happen on success=false without code?)
                        notifier.alert(response.message);
                        isProcessing = false;
                    }
                },
                error: function (err) {
                    isProcessing = false;
                    const resp = err.responseJSON;

                    if (resp && resp.is_far) {
                        // Open Manual Override Modal
                        $('#manual-qr-code').val(qrCode);
                        $('#manual-message').text(resp.message);
                        $('#modal-manual-stamp').modal('show');
                    } else {
                        notifier.alert("Error: " + (resp ? resp.message : err.statusText));
                        $('#scan-status').text("Error: " + (resp ? resp.message : err.statusText));
                        // Offer retry
                        $('#retry-btn').removeClass('d-none');
                    }
                }
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (lastDecodedText === decodedText && isProcessing) return;
            lastDecodedText = decodedText;
            console.log(`Code matched = ${decodedText}`, decodedResult);

            submitScan(decodedText);
        }

        function startCamera() {
            $('#result-area').addClass('d-none');
            $('#reader-container').removeClass('d-none');
            $('#retry-btn').addClass('d-none');

            if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (errorMessage) => { /* ignore/log */ }
            ).catch(err => {
                notifier.alert("Error starting camera: " + err);
                $('#reader-container').addClass('d-none');
            });
        }

        $(document).ready(function () {
            getGPS();
            startCamera(); // Auto-start

            // CAMERA BUTTON (Restart)
            $('#btn-camera').click(function () {
                isProcessing = false;
                startCamera();
            });

            // STOP CAMERA
            $('#stop-camera').click(function () {
                if (html5QrCode) html5QrCode.stop().then(() => {
                    $('#reader-container').addClass('d-none');
                }).catch(console.error);
            });

            // FILE INPUT
            $('#qr-file').change(function (e) {
                if (e.target.files.length == 0) return;
                var file = e.target.files[0];

                html5QrCode.scanFile(file, true)
                    .then(decodedText => {
                        onScanSuccess(decodedText, null);
                    })
                    .catch(err => {
                        notifier.alert("Error reading file or No QR code found.");
                        console.log(err);
                    });
            });

            // RETRY
            $('#retry-btn').click(function () {
                location.reload();
            });

            // MANUAL CONFIRM
            $('#confirm-manual-btn').click(function () {
                const qr = $('#manual-qr-code').val();
                const notes = $('#manual-notes').val();
                if (!notes) {
                    alert("Please enter a note.");
                    return;
                }
                $('#modal-manual-stamp').modal('hide');
                submitScan(qr, true, notes);
            });

        });
    </script>

    <!-- Manual Stamp Modal -->
    <div class="modal fade" id="modal-manual-stamp">
        <div class="modal-dialog">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Distance Warning</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="manual-message" class="font-weight-bold">You are too far from the site.</p>
                    <p>You can force the stamp by providing a reason.</p>
                    <input type="hidden" id="manual-qr-code">
                    <div class="form-group">
                        <label>Reason / Note (*)</label>
                        <textarea id="manual-notes" class="form-control" rows="3"
                            placeholder="e.g. GPS error, Working off-site..."></textarea>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" id="confirm-manual-btn" class="btn btn-danger">Stamp Anyway</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>